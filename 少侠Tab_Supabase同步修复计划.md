# 少侠Tab Supabase数据同步修复计划

**创建日期**: 2026-02-09  
**状态**: 待实施  
**目标**: 完善"少侠"Tab的所有数据同步和保存功能

---

## 📋 当前状态分析

### ✅ 已完成的功能
1. **Supabase数据库连接** - 已连接并正常工作
2. **基础数据表** - students, daily_progress, habit_checks, schedule_items, weekly_achievements, user_photos
3. **前端同步代码** - 部分功能已添加

### ❌ 当前存在的问题

| 功能 | 前端状态 | Supabase同步 | 问题描述 |
|------|---------|-------------|---------|
| 头像选择 | ✅ 正常工作 | ⚠️ 部分同步 | 切换后保存，但读取时有bug |
| 照片上传 | ✅ 正常工作 | ❌ 未完成 | 代码已添加但未测试 |
| 用户名修改 | ❌ 显示"开发中" | ❌ 未开始 | 功能未实现 |
| 修炼日记 | ✅ 正常工作 | ❌ 未完成 | 未同步到Supabase |
| 设置功能 | ❌ 未实现 | ❌ 未开始 | 全部"开发中" |

---

## 🎯 修复目标

### 1. 完善数据同步
- [ ] 头像切换 - 确保保存和读取都正常
- [ ] 照片上传 - 测试同步功能
- [ ] 用户名修改 - 实现保存功能
- [ ] 修炼日记 - 同步到Supabase

### 2. 完善前端功能
- [ ] 实现"设置"Tab的全部功能
- [ ] 添加数据实时同步指示器
- [ ] 优化用户体验

### 3. 测试验证
- [ ] 本地测试所有同步功能
- [ ] 验证GitHub Pages部署
- [ ] 跨设备数据同步测试

---

## 🔧 详细修复计划

### 第一阶段：数据同步修复

#### 1.1 头像同步问题修复
**问题**: 头像切换后保存，但刷新页面后可能丢失

**原因分析**:
```
当前流程:
1. selectAvatar() 调用 SupabaseClient.createOrUpdateStudent()
2. loadFromSupabase() 读取学生信息
3. 但头像显示可能未正确更新DOM
```

**修复方案**:
```
1. 检查 createOrUpdateStudent() 返回值
2. 确保 loadFromSupabase() 正确更新全局变量
3. 添加头像更新后的DOM刷新逻辑
4. 测试验证
```

#### 1.2 照片同步测试和完善
**当前状态**: 代码已添加，需要测试

**测试步骤**:
```
1. 打开少侠Tab
2. 上传1-2张照片
3. 刷新页面
4. 验证照片是否还在
5. 检查Supabase数据
```

**可能的问题**:
```
1. 照片数据太大（Base64）
   - 解决方案: 限制照片大小或使用Storage
   
2. 加载时只读未同步的照片
   - 修复: 确保userPhotos数组正确更新
```

#### 1.3 用户名修改功能
**当前状态**: "开发中"提示

**需要实现**:
```
1. 创建用户名输入框
2. 添加保存按钮
3. 实现 SupabaseClient.updateUserName()
4. 同步到Supabase
5. 本地同步更新
```

**数据结构**:
```
students表已有name字段
{
  "id": "11111111-...",
  "name": "彦平少侠",  // 需要修改这个
  "avatar": "ninja"
}
```

---

### 第二阶段：前端功能完善

#### 2.1 实现"设置"Tab
**当前状态**: 显示"设置功能还在开发"

**需要的功能**:
```
1. 用户名修改
   - 输入框 + 保存按钮
   
2. 数据管理
   - 查看同步状态
   - 手动同步按钮
   - 清除本地数据选项
   
3. 关于
   - 版本信息
   - 数据统计
```

#### 2.2 同步状态指示器
**目的**: 让用户知道数据是否已同步

**UI设计**:
```
Tab栏下方添加状态栏:
[头像] [数据: ☁️已同步]
```

**实现逻辑**:
```
1. 定义同步状态变量: isSynced (true/false)
2. 每次保存操作后设置为true
3. 每次加载时设置为true
4. 失败时设置为false
5. 显示相应图标
```

#### 2.3 修炼日记完善
**当前状态**: 照片已显示，未同步

**同步方案**:
```
已添加:
- SupabaseClient.addUserPhoto()
- SupabaseClient.getUserPhotos()

待测试:
- 照片上传同步
- 照片删除同步
```

---

### 第三阶段：测试验证

#### 3.1 本地测试清单
```
[ ] 头像切换
    - 选择新头像
    - 刷新页面
    - 验证头像保持
    
[ ] 照片上传
    - 上传1张照片
    - 验证显示
    - 刷新页面
    - 验证照片还在
    
[ ] 用户名修改
    - 输入新名字
    - 保存
    - 刷新页面
    - 验证名字更新
    
[ ] 修炼日记
    - 上传多张照片
    - 删除照片
    - 验证Supabase数据
```

#### 3.2 GitHub Pages测试
```
1. 部署完成后访问:
   https://rdx025.github.io/winterplan2026/

2. 重复本地测试清单

3. 测试跨设备同步
   - 在另一台设备打开
   - 验证数据一致
```

---

## 📁 需要修改的文件

### 核心文件
```
app.js                    - 主要逻辑和同步代码
supabase-client.js        - Supabase API封装
index.html               - UI结构
style.css                - 样式
```

### 数据库表（已完成）
```
students               ✅ 已创建
user_photos           ✅ 已创建
```

---

## 🚀 执行顺序

### 步骤1: 修复头像同步
- [ ] 检查 createOrUpdateStudent() 实现
- [ ] 修复 loadFromSupabase() 中的头像读取
- [ ] 测试验证

### 步骤2: 测试照片同步
- [ ] 执行照片上传测试
- [ ] 修复发现的问题
- [ ] 验证Supabase数据

### 步骤3: 实现用户名修改
- [ ] 创建输入UI
- [ ] 实现保存逻辑
- [ ] 添加同步代码
- [ ] 测试验证

### 步骤4: 完善修炼日记
- [ ] 测试照片同步
- [ ] 添加删除同步（可选）

### 步骤5: 实现设置Tab
- [ ] 添加设置UI
- [ ] 同步状态指示器
- [ ] 数据管理功能

### 步骤6: 测试验证
- [ ] 本地完整测试
- [ ] GitHub Pages测试
- [ ] 修复发现的问题

---

## ⚠️ 风险和注意事项

### 1. 数据大小限制
```
问题: Base64照片数据可能太大
限制: 建议限制单张照片 < 500KB
方案: 前端压缩或使用Supabase Storage
```

### 2. 同步冲突
```
问题: 多设备修改同一数据
当前方案: 简单覆盖（最后保存优先）
后续优化: 添加时间戳对比
```

### 3. 离线支持
```
当前状态: localStorage作为后备
待完善: 离线时提示用户
待实现: 上线后自动同步
```

---

## 📊 验收标准

### 功能验收
```
[ ] 头像切换后保持（刷新不丢失）
[ ] 照片上传后保持（刷新不丢失）
[ ] 用户名可修改（刷新后保持）
[ ] 修炼日记同步（照片不丢失）
```

### 性能验收
```
[ ] 页面加载 < 2秒
[ ] 同步操作 < 1秒
[ ] 无明显延迟感
```

---

## 📝 后续优化方向

1. **Supabase Storage**
   - 使用Storage存储照片（替代Base64）
   - 减少数据库负担

2. **实时同步**
   - 使用Supabase Realtime
   - 多设备实时更新

3. **数据备份**
   - 导出功能
   - 导入功能

---

**文档版本**: 1.0  
**最后更新**: 2026-02-09
