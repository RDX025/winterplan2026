<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¯å¢ƒå˜é‡è°ƒè¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
      font-size: 14px;
    }
    .status {
      margin: 10px 0;
      padding: 10px;
      background: #2a2a2a;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    .error { border-color: #f44336; background: #2a1a1a; }
    .warn { border-color: #ff9800; background: #2a2a1a; }
    .section { margin-bottom: 20px; }
    .section-title { font-weight: bold; margin-bottom: 10px; color: #888; }
    pre { background: #0a0a0a; padding: 10px; border-radius: 4px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>ğŸ”§ ç¯å¢ƒå˜é‡è°ƒè¯•</h1>
  
  <div id="output"></div>
  
  <script>
    const output = document.getElementById('output');
    
    function log(msg, level = 'info') {
      const div = document.createElement('div');
      div.className = 'status ' + level;
      div.textContent = msg;
      output.appendChild(div);
    }
    
    function section(title) {
      const div = document.createElement('div');
      div.className = 'section';
      div.innerHTML = '<div class="section-title">' + title + '</div>';
      output.appendChild(div);
      return div;
    }
    
    // æ£€æŸ¥ç¯å¢ƒå˜é‡
    section('ğŸ“¦ Vite ç¯å¢ƒå˜é‡');
    
    const url = import.meta.env?.VITE_SUPABASE_URL || 'undefined';
    const key = import.meta.env?.VITE_SUPABASE_ANON_KEY || 'undefined';
    
    log('VITE_SUPABASE_URL: ' + (url ? (url.substring(0, 50) + '...') : 'âŒ æœªé…ç½®'));
    log('VITE_SUPABASE_ANON_KEY: ' + (key !== 'undefined' ? 'âœ… å·²é…ç½® (é•¿åº¦: ' + key.length + ')' : 'âŒ æœªé…ç½®'));
    log('MODE: ' + (import.meta.env?.MODE || 'unknown'));
    log('BASE_URL: ' + (import.meta.env?.BASE_URL || 'unknown'));
    
    // å°è¯•åˆ›å»º Supabase å®¢æˆ·ç«¯ï¼ˆå†…è”ï¼Œä¸ä¾èµ–å¯¼å…¥ï¼‰
    section('ğŸ”Œ Supabase è¿æ¥æµ‹è¯•');
    
    if (url && url.startsWith('http') && key && key.startsWith('eyJ')) {
      log('âœ… ç¯å¢ƒå˜é‡æœ‰æ•ˆï¼Œå°è¯•è¿æ¥...');
      
      // åŠ¨æ€åŠ è½½ supabase-js
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
      script.onload = async () => {
        try {
          const supabase = window.supabase.createClient(url, key);
          const { data, error } = await supabase.from('students').select('id').limit(1);
          
          if (error) {
            log('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
            log('å¯èƒ½åŸå› : RLSç­–ç•¥é˜»æ­¢è®¿é—® æˆ– è¡¨ä¸å­˜åœ¨', 'warn');
          } else {
            log('âœ… Supabase è¿æ¥æˆåŠŸï¼', 'info');
          }
          
          // æ£€æŸ¥ schedule_items è¡¨
          section('ğŸ“… schedule_items è¡¨æ£€æŸ¥');
          const { data: scheduleData, error: scheduleError } = await supabase
            .from('schedule_items')
            .select('count', { count: 'exact', head: true });
            
          if (scheduleError) {
            log('âŒ schedule_items è¡¨è®¿é—®å¤±è´¥: ' + scheduleError.message, 'error');
            log('æç¤º: ç¡®ä¿ RLS ç­–ç•¥å…è®¸ anon key è¯»å–æ•°æ®', 'warn');
          } else {
            log('âœ… schedule_items è¡¨å¯è®¿é—®', 'info');
            log('è®°å½•æ•°: ' + (scheduleData?.[0]?.count || 0), 'info');
          }
          
        } catch (e) {
          log('âŒ å¼‚å¸¸: ' + e.message, 'error');
        }
      };
      script.onerror = () => log('âŒ æ— æ³•åŠ è½½ Supabase SDK', 'error');
      document.head.appendChild(script);
      
    } else {
      log('âŒ ç¯å¢ƒå˜é‡æ— æ•ˆï¼Œæ— æ³•è¿æ¥ Supabase', 'error');
      if (!url || !url.startsWith('http')) {
        log('âš ï¸ VITE_SUPABASE_URL æœªé…ç½®æˆ–æ ¼å¼é”™è¯¯', 'warn');
      }
      if (!key || !key.startsWith('eyJ')) {
        log('âš ï¸ VITE_SUPABASE_ANON_KEY æœªé…ç½®æˆ–æ ¼å¼é”™è¯¯', 'warn');
      }
    }
    
    // æ£€æŸ¥ window å¯¹è±¡
    section('ğŸªŸ Window å¯¹è±¡æ£€æŸ¥');
    log('window.supabase: ' + (window.supabase ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
    log('window.scheduleStore: ' + (window.scheduleStore ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
    log('window.Calendar: ' + (window.Calendar ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'));
  </script>
</body>
</html>
